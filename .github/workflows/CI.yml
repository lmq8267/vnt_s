name: ÁºñËØëvnts

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  TZ: Asia/Shanghai

permissions:
  contents: write
  actions: write
  
jobs:
 build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - TARGET: aarch64-unknown-linux-musl
            OS: ubuntu-latest
            FEATURES: normal,web
            STRIP: aarch64-linux-musl-strip
            
          - TARGET: armv7-unknown-linux-musleabihf
            OS: ubuntu-latest
            FEATURES: normal,web
            STRIP: armv7l-linux-musleabihf-strip
            
          - TARGET: armv7-unknown-linux-musleabi
            OS: ubuntu-latest
            FEATURES: normal,web
            STRIP: armv7m-linux-musleabi-strip
            
          - TARGET: arm-unknown-linux-musleabihf
            OS: ubuntu-latest
            FEATURES: normal,web
            STRIP: arm-linux-musleabihf-strip
            
          - TARGET: arm-unknown-linux-musleabi
            OS: ubuntu-latest
            FEATURES: normal,web
            STRIP: arm-linux-musleabi-strip
            
          - TARGET: mipsel-unknown-linux-musl
            OS: ubuntu-latest
            FEATURES: normal,web
            STRIP: mipsel-linux-musl-strip
            
          - TARGET: mips-unknown-linux-musl
            OS: ubuntu-latest
            FEATURES: normal
            STRIP: mips-linux-musl-strip
            
          - TARGET: x86_64-unknown-linux-musl
            OS: ubuntu-latest
            FEATURES: ring-cipher,web
            STRIP: strip
            
          - TARGET: x86_64-unknown-freebsd
            OS: ubuntu-latest
            FEATURES: normal,web

          - TARGET: i686-pc-windows-msvc
            OS: windows-latest
            FEATURES: ring-cipher,web
            
          - TARGET: x86_64-pc-windows-msvc
            OS: windows-latest
            FEATURES: ring-cipher,web
            
    runs-on: ${{ matrix.OS }}
    env:
      NAME: vnts_${{ matrix.TARGET }}
      TARGET: ${{ matrix.TARGET }}
      OS: ${{ matrix.OS }}
      STRIP: ${{ matrix.STRIP }}
      FEATURES: ${{ matrix.FEATURES }}
      
    steps:
      - uses: actions/checkout@v5
      
      - name: ËÆæÁΩÆÁºñËØëÁéØÂ¢É
        if: ${{ matrix.TARGET != 'x86_64-unknown-freebsd' }}
        shell: bash
        run: |
            if [[ $OS =~ ^ubuntu.*$ ]]; then
            case $TARGET in 
              mipsel-unknown-linux-musl)
                MUSL_URI=mipsel-linux-musl-cross
                ;;
              aarch64-unknown-linux-musl)
                MUSL_URI=aarch64-linux-musl-cross
                ;;
              armv7-unknown-linux-musleabihf)
                MUSL_URI=armv7l-linux-musleabihf-cross
                ;;
              armv7-unknown-linux-musleabi)
                MUSL_URI=armv7m-linux-musleabi-cross
                ;;
              arm-unknown-linux-musleabihf)
                MUSL_URI=arm-linux-musleabihf-cross
                ;;
              arm-unknown-linux-musleabi)
                MUSL_URI=arm-linux-musleabi-cross
                ;;
              mips-unknown-linux-musl)
                MUSL_URI=mips-linux-musl-cross
                ;;
              x86_64-unknown-linux-musl)
                MUSL_URI=x86_64-linux-musl-cross
                ;;
            esac
              echo "MUSL_URI=${MUSL_URI}" >> $GITHUB_ENV
              mkdir -p /opt/musl_gcc 
              wget -c https://github.com/lmq8267/Toolchain/releases/download/musl-cross/$MUSL_URI.tgz -P /opt/musl_gcc/
              tar zxf /opt/musl_gcc/$MUSL_URI.tgz -C /opt/musl_gcc/
              sudo ln -s /opt/musl_gcc/$MUSL_URI/bin/*gcc /usr/bin/
            if [[ $TARGET == mips-unknown-linux-musl ]] || [[ $TARGET == mipsel-unknown-linux-musl ]] ; then
            rustup install 1.72.1
            rustup default 1.72.1
            fi
            if [[ $TARGET =~ "x86_64-unknown-linux-musl" ]] ; then
              sudo apt-get update && sudo apt-get install -qq musl-tools
            fi
            sudo timedatectl set-timezone "Asia/Shanghai"
            fi
            cat >>~/.cargo/config <<EOF
            [target.x86_64-unknown-linux-musl]
            linker = "x86_64-linux-musl-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.aarch64-unknown-linux-musl]
            linker = "aarch64-linux-musl-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.armv7-unknown-linux-musleabihf]
            linker = "armv7l-linux-musleabihf-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.armv7-unknown-linux-musleabi]
            linker = "armv7m-linux-musleabi-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.arm-unknown-linux-musleabihf]
            linker = "arm-linux-musleabihf-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.arm-unknown-linux-musleabi]
            linker = "arm-linux-musleabi-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.mipsel-unknown-linux-musl]
            linker = "mipsel-linux-musl-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.mips-unknown-linux-musl]
            linker = "mips-linux-musl-gcc"
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols", "--remap-path-prefix=/=."]
            [target.x86_64-pc-windows-msvc]
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols"]    
            [target.i686-pc-windows-msvc]
            rustflags = ["-C", "target-feature=+crt-static","-C", "strip=symbols"] 
            EOF
            
      - name: Ê∑ªÂä†ÁºñËØëÂπ≥Âè∞
        run: rustup target add ${{ matrix.target }}
        
      - name: ÂºÄÂßãÁºñËØë
        if: ${{ matrix.TARGET != 'x86_64-unknown-freebsd' }}
        run: |
          cd vnts
          cargo build --release --target ${{ matrix.target }} --features ${{ matrix.FEATURES }}
        
      - name: ÁºñËØëFreeBSD
        if: ${{ matrix.TARGET == 'x86_64-unknown-freebsd' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user qemu-user-static binfmt-support build-essential
          cd vnts
          cargo install cross --git https://github.com/cross-rs/cross
          sed -i 's/const CLOCK_ID: ClockId = ClockId::CLOCK_BOOTTIME;/const CLOCK_ID: ClockId = ClockId::CLOCK_MONOTONIC;/g' ./lib/boringtun/src/sleepyinstant/unix.rs
          cross build --target ${{ matrix.target }} --release --features $FEATURES
          
      - name: ÂÆâË£Ö UPX
        if: ${{ matrix.TARGET != 'x86_64-unknown-freebsd' }}
        uses: crazy-max/ghaction-upx@v3
        with:
          version: v4.2.4
          install-only: true
          
      - name: ÊâìÂåÖÂéãÁº©
        run: upx --lzma --best vnts/target/${{ matrix.target }}/release/vnts* || true

      - name: ‰∏ä‰º†‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
         name: vnts-${{ matrix.target }}
         path: |
           vnts/target/${{ matrix.target }}/release/vnts
           vnts/target/${{ matrix.target }}/release/vnts.exe

      - name: ÁîüÊàêÊûÑÂª∫ÊëòË¶Å
        shell: bash
        run: |
          echo "## üì¶ ÊûÑÂª∫ÊëòË¶Å - ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã ÊûÑÂª∫‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "- **ÊûÑÂª∫Êó∂Èó¥**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **Êèê‰∫§ÂìàÂ∏å**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Á®ãÂ∫èÊñá‰ª∂" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ matrix.OS }}" == "windows-latest" ]]; then
            FILE_PATH="vnts/target/${{ matrix.target }}/release/vnts.exe"
            FILE_NAME="vnts.exe"
          else
            FILE_PATH="vnts/target/${{ matrix.target }}/release/vnts"
            FILE_NAME="vnts"
          fi
          if [ -f "$FILE_PATH" ]; then
            FILE_SIZE=$(ls -lh "$FILE_PATH" | awk '{print $5}')
            echo "- **Êñá‰ª∂Âêç**: $FILE_NAME" >> $GITHUB_STEP_SUMMARY
            echo "- **Â§ßÂ∞è**: $FILE_SIZE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• ‰∏ãËΩΩÊñπÂºè" >> $GITHUB_STEP_SUMMARY
          echo "1. ÁÇπÂáª‰∏ãÊñπÁöÑ **Artifacts** ‰∏ãËΩΩÊûÑÂª∫‰∫ßÁâ©" >> $GITHUB_STEP_SUMMARY
          echo "2. ÊàñÂú® Actions È°µÈù¢ÊâæÂà∞Êú¨Ê¨°ÊûÑÂª∫Ôºå‰∏ãËΩΩ artifact" >> $GITHUB_STEP_SUMMARY

      -
       name: Âà†Èô§Â∑•‰ΩúÊµÅ
       uses: Mattraks/delete-workflow-runs@main
       with:
        token: ${{ secrets.GITHUB_TOKEN }}
        retain_days: 0
        keep_minimum_runs: 0
